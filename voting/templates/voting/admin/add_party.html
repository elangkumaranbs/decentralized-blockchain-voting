{% extends 'voting/admin/base.html' %}
{% load static %}

{% block title %}Add Party - Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin: 20px 0;
    }
    
    .form-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 15px;
        margin-bottom: 30px;
    }
    
    .form-header h3 {
        color: #495057;
        margin: 0;
        font-weight: 600;
    }
    
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        flex: 1;
    }
    
    .form-group.full-width {
        flex: 100%;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 15px;
        font-size: 14px;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }
    
    .form-control.is-invalid {
        border-color: #dc3545;
    }
    
    .form-control.is-valid {
        border-color: #28a745;
    }
    
    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 5px;
    }
    
    .valid-feedback {
        color: #28a745;
        font-size: 0.875rem;
        margin-top: 5px;
    }
    
    .file-upload-area {
        border: 2px dashed #e9ecef;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .file-upload-area:hover {
        border-color: #007bff;
        background: #f8f9fa;
    }
    
    .file-upload-area.dragover {
        border-color: #007bff;
        background: #e7f3ff;
    }
    
    .file-upload-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 15px;
    }
    
    .file-upload-text {
        color: #6c757d;
        margin-bottom: 10px;
    }
    
    .file-preview {
        margin-top: 15px;
        text-align: center;
    }
    
    .file-preview img {
        max-width: 150px;
        max-height: 150px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .color-picker-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .color-input {
        width: 60px;
        height: 40px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .color-preview {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #e9ecef;
    }
    
    .btn-group {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }
    
    .btn {
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
        transform: translateY(-1px);
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #1e7e34;
        transform: translateY(-1px);
    }
    
    .required {
        color: #dc3545;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .char-counter {
        font-size: 0.875rem;
        color: #6c757d;
        text-align: right;
        margin-top: 5px;
    }
    
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 0;
        }
        
        .btn-group {
            flex-direction: column;
        }
        
        .color-picker-container {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-plus-circle me-2"></i>Add Political Party</h2>
        <p class="text-muted mb-0">Add a new political party to the system</p>
    </div>
    <a href="{% url 'voting:admin_parties' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Parties
    </a>
</div>

<div class="form-container">
    <div class="form-header">
        <h3>Party Information</h3>
    </div>
    
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <form method="post" enctype="multipart/form-data" id="partyForm">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Party Name <span class="required">*</span></label>
                <input type="text" class="form-control" name="name" id="name" required>
                <div class="char-counter"><span id="nameCounter">0</span>/100</div>
            </div>
            <div class="form-group">
                <label class="form-label">Party Symbol <span class="required">*</span></label>
                <input type="text" class="form-control" name="symbol" id="symbol" required>
                <div class="help-text">Short symbol or abbreviation</div>
            </div>
        </div>
        
        <!-- Description -->
        <div class="form-group full-width">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" id="description" rows="4" maxlength="500" placeholder="Enter party description, manifesto highlights, or key policies..."></textarea>
            <div class="char-counter"><span id="descCounter">0</span>/500</div>
        </div>
        
        <!-- Leader Information -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Party Leader</label>
                <input type="text" class="form-control" name="leader" id="leader" placeholder="Name of party leader">
            </div>
            <div class="form-group">
                <label class="form-label">Founded Year</label>
                <input type="number" class="form-control" name="founded_year" id="founded_year" min="1800" max="2024" placeholder="YYYY">
            </div>
        </div>
        
        <!-- Contact Information -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Website</label>
                <input type="url" class="form-control" name="website" id="website" placeholder="https://example.com">
            </div>
            <div class="form-group">
                <label class="form-label">Contact Email</label>
                <input type="email" class="form-control" name="contact_email" id="contact_email" placeholder="contact@party.com">
            </div>
        </div>
        
        <!-- Visual Identity -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Party Color</label>
                <div class="color-picker-container">
                    <input type="color" class="color-input" name="color" id="color" value="#007bff">
                    <div class="color-preview" id="colorPreview" style="background-color: #007bff;"></div>
                    <input type="text" class="form-control" id="colorHex" value="#007bff" placeholder="#000000" maxlength="7">
                </div>
                <div class="help-text">Choose the primary color for this party</div>
            </div>
            <div class="form-group">
                <label class="form-label">Headquarters</label>
                <input type="text" class="form-control" name="headquarters" id="headquarters" placeholder="City, State">
            </div>
        </div>
        
        <!-- Party Logo -->
        <div class="form-group full-width">
            <label class="form-label">Party Logo</label>
            <div class="file-upload-area" id="fileUploadArea">
                <div class="file-upload-icon">
                    <i class="fas fa-image"></i>
                </div>
                <div class="file-upload-text">
                    <strong>Click to upload logo</strong> or drag and drop
                </div>
                <div class="text-muted">PNG, JPG, SVG up to 5MB</div>
                <input type="file" name="logo" id="logo" accept="image/*" style="display: none;">
            </div>
            <div class="file-preview" id="filePreview" style="display: none;"></div>
        </div>
        
        <!-- Additional Information -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Ideology</label>
                <select class="form-control" name="ideology" id="ideology">
                    <option value="">Select Ideology</option>
                    <option value="liberal">Liberal</option>
                    <option value="conservative">Conservative</option>
                    <option value="socialist">Socialist</option>
                    <option value="centrist">Centrist</option>
                    <option value="nationalist">Nationalist</option>
                    <option value="regional">Regional</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-control" name="status" id="status">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                <i class="fas fa-undo me-2"></i>Reset
            </button>
            <button type="submit" class="btn btn-success" name="save_and_add_another">
                <i class="fas fa-plus me-2"></i>Save and add another
            </button>
            <button type="submit" class="btn btn-primary" name="save_and_continue_editing">
                <i class="fas fa-edit me-2"></i>Save and continue editing
            </button>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i>SAVE
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Character counters
document.getElementById('name').addEventListener('input', function(e) {
    const counter = document.getElementById('nameCounter');
    counter.textContent = e.target.value.length;
    
    if (e.target.value.length > 100) {
        e.target.value = e.target.value.substring(0, 100);
        counter.textContent = 100;
    }
});

document.getElementById('description').addEventListener('input', function(e) {
    const counter = document.getElementById('descCounter');
    counter.textContent = e.target.value.length;
});

// Color picker functionality
const colorInput = document.getElementById('color');
const colorPreview = document.getElementById('colorPreview');
const colorHex = document.getElementById('colorHex');

colorInput.addEventListener('change', function(e) {
    const color = e.target.value;
    colorPreview.style.backgroundColor = color;
    colorHex.value = color;
});

colorHex.addEventListener('input', function(e) {
    const color = e.target.value;
    if (/^#[0-9A-F]{6}$/i.test(color)) {
        colorInput.value = color;
        colorPreview.style.backgroundColor = color;
    }
});

// File upload handling
const fileUploadArea = document.getElementById('fileUploadArea');
const fileInput = document.getElementById('logo');
const filePreview = document.getElementById('filePreview');

fileUploadArea.addEventListener('click', () => fileInput.click());

fileUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadArea.classList.add('dragover');
});

fileUploadArea.addEventListener('dragleave', () => {
    fileUploadArea.classList.remove('dragover');
});

fileUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            filePreview.innerHTML = `<img src="${e.target.result}" alt="Logo Preview">`;
            filePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

// Form validation
document.getElementById('partyForm').addEventListener('submit', function(e) {
    const requiredFields = ['name', 'symbol'];
    let isValid = true;
    
    requiredFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    });
    
    // Validate website URL
    const website = document.getElementById('website').value;
    if (website && !/^https?:\/\/.+/.test(website)) {
        document.getElementById('website').classList.add('is-invalid');
        isValid = false;
    }
    
    // Validate email
    const email = document.getElementById('contact_email').value;
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        document.getElementById('contact_email').classList.add('is-invalid');
        isValid = false;
    }
    
    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields correctly.');
    }
});

// Real-time validation
document.getElementById('website').addEventListener('input', function(e) {
    const value = e.target.value;
    if (value && !/^https?:\/\/.+/.test(value)) {
        e.target.classList.add('is-invalid');
    } else {
        e.target.classList.remove('is-invalid');
        if (value) e.target.classList.add('is-valid');
    }
});

document.getElementById('contact_email').addEventListener('input', function(e) {
    const value = e.target.value;
    if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
        e.target.classList.add('is-invalid');
    } else {
        e.target.classList.remove('is-invalid');
        if (value) e.target.classList.add('is-valid');
    }
});

// Auto-generate symbol from name
document.getElementById('name').addEventListener('input', function(e) {
    const symbolField = document.getElementById('symbol');
    if (!symbolField.value) {
        const words = e.target.value.split(' ');
        const symbol = words.map(word => word.charAt(0).toUpperCase()).join('').substring(0, 5);
        symbolField.value = symbol;
    }
});

function resetForm() {
    if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
        document.getElementById('partyForm').reset();
        filePreview.style.display = 'none';
        
        // Reset color picker
        colorInput.value = '#007bff';
        colorPreview.style.backgroundColor = '#007bff';
        colorHex.value = '#007bff';
        
        // Reset counters
        document.getElementById('nameCounter').textContent = '0';
        document.getElementById('descCounter').textContent = '0';
        
        // Remove validation classes
        document.querySelectorAll('.form-control').forEach(field => {
            field.classList.remove('is-valid', 'is-invalid');
        });
    }
}

// Auto-dismiss alerts
setTimeout(function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
}, 5000);
</script>
{% endblock %}