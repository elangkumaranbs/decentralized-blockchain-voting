{% extends 'voting/base.html' %}

{% block title %}Vote Now - Decentralized Voting System{% endblock %}

{% block extra_head %}
<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="voting-container p-4">
            <div class="text-center mb-4">
                <h1 class="display-4 text-primary mb-3">
                    <i class="fas fa-vote-yea me-3"></i>
                    Cast Your Vote
                </h1>
                <p class="lead text-muted">{{ session.session_name }}</p>

            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step-1">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="step" id="step-2">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="step" id="step-3">
                    <i class="fas fa-vote-yea"></i>
                </div>
            </div>

            <!-- Step 1: Aadhaar Image-Based Verification -->
            <div class="verification-step active" id="verification-form">
                <h3 class="text-center mb-4">Step 1: Aadhaar Verification</h3>
                <div class="aadhaar-verification-container">
                    <!-- Aadhaar Card Image Input -->
                    <div class="aadhaar-input-section text-center mb-4">
                        <div class="aadhaar-card-preview" id="aadhaar-preview">
                            <svg width="300" height="180" viewBox="0 0 300 180" class="aadhaar-card-template">
                                <!-- Aadhaar Card Background -->
                                <rect width="300" height="180" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2" rx="10"/>
                                
                                <!-- Header -->
                                <rect x="10" y="10" width="280" height="30" fill="#0d6efd" rx="5"/>
                                <text x="150" y="30" text-anchor="middle" fill="white" font-size="14" font-weight="bold">AADHAAR</text>
                                
                                <!-- Photo placeholder -->
                                <rect x="20" y="50" width="60" height="70" fill="#e9ecef" stroke="#adb5bd" rx="5"/>
                                <text x="50" y="90" text-anchor="middle" fill="#6c757d" font-size="10">PHOTO</text>
                                
                                <!-- Details section -->
                                <text x="90" y="65" fill="#495057" font-size="10">Name: <tspan id="card-name">XXXX XXXX XXXX</tspan></text>
                                <text x="90" y="80" fill="#495057" font-size="10">DOB: <tspan id="card-dob">XX/XX/XXXX</tspan></text>
                                <text x="90" y="95" fill="#495057" font-size="10">Gender: <tspan id="card-gender">X</tspan></text>
                                
                                <!-- Aadhaar Number -->
                                <rect x="20" y="130" width="260" height="25" fill="#fff3cd" stroke="#ffeaa7" rx="3"/>
                                <text x="30" y="145" fill="#856404" font-size="12" font-weight="bold">Aadhaar Number:</text>
                                <text x="30" y="160" fill="#856404" font-size="14" font-weight="bold" id="display-aadhaar">XXXX XXXX XXXX</text>
                            </svg>
                        </div>
                        
                        <!-- Image Upload Section -->
                        <div class="image-upload-section mt-3">
                            <label for="aadhaar-image" class="btn btn-outline-primary btn-lg">
                                <i class="fas fa-camera me-2"></i>Capture/Upload Aadhaar Card
                            </label>
                            <input type="file" id="aadhaar-image" accept="image/*" capture="camera" style="display: none;">
                            <div class="form-text mt-2">Take a photo or upload an image of your Aadhaar card</div>
                        </div>
                    </div>
                    
                    <!-- Manual Input Fallback -->
                    <div class="manual-input-section">
                        <div class="text-center mb-3">
                            <span class="text-muted">Or enter manually:</span>
                        </div>
                        <form id="aadhaar-verification-form">
                            <div class="row justify-content-center">
                                <div class="col-md-8">
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">
                                            <i class="fas fa-id-card"></i>
                                        </span>
                                        <input type="text" class="form-control" id="aadhaar_number" name="aadhaar_number" 
                                               placeholder="Enter 12-digit Aadhaar number" pattern="[0-9]{12}" maxlength="12" required>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search me-2"></i>Verify
                                        </button>
                                    </div>
                                    <div class="form-text">Enter your 12-digit Aadhaar number to find your profile</div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Voter Profile Display -->
                    <div class="voter-profile-section" id="voter-profile" style="display: none;">
                        <div class="card mt-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-user-check me-2"></i>Voter Profile Found
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6 class="card-title" id="profile-name">Loading...</h6>
                                        <p class="card-text">
                                            <strong>Email:</strong> <span id="profile-email">Loading...</span><br>
                                            <strong>Aadhaar:</strong> <span id="profile-aadhaar">Loading...</span><br>
                                            <strong>Status:</strong> <span id="profile-status" class="badge bg-success">Eligible to Vote</span>
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="voter-avatar">
                                            <i class="fas fa-user-circle text-primary" style="font-size: 4rem;"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-success btn-lg" onclick="proceedToVoting()">
                                        <i class="fas fa-arrow-right me-2"></i>Proceed to Voting
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="resetVerification()">
                                        <i class="fas fa-redo me-2"></i>Try Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Email Verification -->
            <div class="verification-step" id="email-verification">
                <h3 class="text-center mb-4">Step 2: Email Verification</h3>
                <div class="text-center mb-4">
                    <div class="alert alert-success">
                        <i class="fas fa-envelope me-2"></i>
                        A verification code has been sent to your email address.
                    </div>
                    <p class="text-muted">Welcome, <strong id="voter-name"></strong>!</p>
                </div>
                <form id="email-verification-form">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <label for="verification_code" class="form-label">
                                <i class="fas fa-key me-2"></i>Verification Code
                            </label>
                            <input type="text" class="form-control text-center" id="verification_code" 
                                   name="verification_code" pattern="[0-9]{6}" maxlength="6" required
                                   placeholder="Enter 6-digit code">
                            <div class="form-text">For demo: Enter any 6-digit number</div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-check me-2"></i>Verify Email
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="goToStep(1)">
                            <i class="fas fa-arrow-left me-2"></i>Back
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 3: Vote Casting -->
            <div class="verification-step" id="vote-casting">
                <h3 class="text-center mb-4">Step 3: Select Your Candidate</h3>
                <div class="alert alert-warning text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> You can only vote once. Please review your selection carefully.
                </div>
                
                <form id="vote-form">
                    {% csrf_token %}
                    <div class="row">
                        {% for party in parties %}
                        <div class="col-md-6 mb-4">
                            <div class="card party-card h-100">
                                <div class="card-body text-center">
                                    {% if party.party_symbol_url %}
                                    <img src="{{ party.party_symbol_url }}" alt="{{ party.party_name }}" 
                                         class="img-fluid mb-3" style="max-height: 80px;">
                                    {% else %}
                                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                                         style="width: 80px; height: 80px; font-size: 2rem;">
                                        {{ party.party_name|first }}
                                    </div>
                                    {% endif %}
                                    
                                    <h5 class="card-title">{{ party.party_name }}</h5>
                                    {% if party.party_leader %}
                                    <p class="card-text"><strong>Leader:</strong> {{ party.party_leader }}</p>
                                    {% endif %}
                                    {% if party.party_description %}
                                    <p class="card-text text-muted small">{{ party.party_description|truncatewords:15 }}</p>
                                    {% endif %}
                                    
                                    <!-- Radio Button -->
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" type="radio" name="party_id" 
                                               value="{{ party.id }}" id="party-{{ party.id }}" style="transform: scale(1.5);">
                                        <label class="form-check-label fw-bold" for="party-{{ party.id }}">
                                            Select {{ party.party_name }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Single Vote Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-vote-yea me-2"></i>Cast My Vote
                        </button>
                        <button type="button" class="btn btn-outline-light btn-lg ms-2" onclick="goToStep(2)">
                            <i class="fas fa-arrow-left me-2"></i>Back to Verification
                        </button>
                    </div>
                </form>
            </div>

            <!-- Success Message -->
            <div class="verification-step" id="vote-success">
                <div class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h3 class="text-success mb-3">Vote Cast Successfully!</h3>
                    <div class="alert alert-success">
                        <p class="mb-2"><strong>Vote ID:</strong> <span id="vote-id"></span></p>
                        <p class="mb-2"><strong>Timestamp:</strong> <span id="vote-timestamp"></span></p>
                        <p class="mb-0"><strong>Blockchain Hash:</strong> <span id="blockchain-hash">Processing...</span></p>
                    </div>
                    <p class="text-muted">Your vote has been recorded on the blockchain for transparency and immutability.</p>
                    <div class="mt-4">
                        <a href="{% url 'voting:results' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-chart-bar me-2"></i>View Results
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loading-message">Processing...</h5>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Enhanced CSS Variables for Consistent Theming */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --error-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    --vote-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --glass-bg: rgba(255, 255, 255, 0.25);
    --glass-border: rgba(255, 255, 255, 0.18);
    --shadow-light: 0 8px 32px rgba(31, 38, 135, 0.37);
    --shadow-hover: 0 15px 35px rgba(31, 38, 135, 0.5);
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Global Enhancements */
body {
    background: var(--primary-gradient);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

/* Floating Particles Background */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 2px, transparent 2px),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 1px, transparent 1px),
        radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 50px 50px, 30px 30px, 70px 70px;
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
    z-index: -1;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    33% { transform: translateY(-10px) rotate(1deg); }
    66% { transform: translateY(5px) rotate(-1deg); }
}

/* Enhanced Voting Container */
.voting-container {
    background: var(--glass-bg);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    box-shadow: var(--shadow-light);
    color: white;
    position: relative;
    overflow: hidden;
    margin: 2rem 0;
}

.voting-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: var(--vote-gradient);
    border-radius: 24px 24px 0 0;
}

/* Enhanced Header Section */
.display-4 {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    font-weight: 800;
    margin-bottom: 1.5rem;
    position: relative;
}

.display-4::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 4px;
    background: var(--vote-gradient);
    border-radius: 2px;
    box-shadow: 0 0 20px rgba(56, 239, 125, 0.6);
}

/* Enhanced Step Indicator */
.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 3rem;
    position: relative;
}

.step-indicator::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 15%;
    right: 15%;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    z-index: 1;
}

.step {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    border: 3px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 2rem;
    font-size: 1.8rem;
    transition: var(--transition);
    position: relative;
    z-index: 2;
    box-shadow: var(--shadow-light);
}

.step.active {
    background: white;
    color: #667eea;
    transform: scale(1.2);
    border-color: rgba(255, 255, 255, 0.8);
    box-shadow: 0 15px 35px rgba(255, 255, 255, 0.4);
    animation: stepPulse 2s ease-in-out infinite;
}

@keyframes stepPulse {
    0%, 100% { box-shadow: 0 15px 35px rgba(255, 255, 255, 0.4), 0 0 0 0 rgba(255, 255, 255, 0.3); }
    50% { box-shadow: 0 15px 35px rgba(255, 255, 255, 0.4), 0 0 0 15px rgba(255, 255, 255, 0.1); }
}

.step.completed {
    background: var(--vote-gradient);
    color: white;
    border-color: rgba(56, 239, 125, 0.8);
    box-shadow: 0 10px 25px rgba(56, 239, 125, 0.4);
}

/* Enhanced Verification Steps */
.verification-step {
    display: none;
    padding: 2rem;
}

.verification-step.active {
    display: block;
    animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeInUp {
    from { 
        opacity: 0; 
        transform: translateY(40px) scale(0.95); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}

/* Enhanced Aadhaar Verification */
.aadhaar-verification-container {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    padding: 3rem;
    box-shadow: var(--shadow-light);
    position: relative;
    overflow: hidden;
}

.aadhaar-verification-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
    opacity: 0.3;
    z-index: -1;
}

.aadhaar-card-template {
    filter: drop-shadow(0 10px 25px rgba(0,0,0,0.3));
    transition: var(--transition);
    border-radius: 15px;
}

.aadhaar-card-template:hover {
    transform: scale(1.05) rotateY(5deg);
    filter: drop-shadow(0 15px 35px rgba(0,0,0,0.4));
}

.aadhaar-input-section {
    border-bottom: 2px solid rgba(255,255,255,0.2);
    padding-bottom: 3rem;
    margin-bottom: 3rem;
    position: relative;
}

.aadhaar-input-section::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 4px;
    background: var(--vote-gradient);
    border-radius: 2px;
}

/* Enhanced Image Upload */
.image-upload-section label {
    background: var(--vote-gradient);
    border: none;
    border-radius: 50px;
    padding: 1.2rem 3rem;
    font-size: 1.1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: var(--transition);
    box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
    position: relative;
    overflow: hidden;
}

.image-upload-section label::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s ease;
}

.image-upload-section label:hover::before {
    left: 100%;
}

.image-upload-section label:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(17, 153, 142, 0.6);
}

.manual-input-section {
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 2rem;
    margin-bottom: 2rem;
}

.input-group-lg .form-control {
    font-size: 1.1rem;
    padding: 15px 20px;
}

.input-group-text {
    background: rgba(255,255,255,0.9);
    border: none;
    color: #667eea;
    font-size: 1.2rem;
}

.voter-profile-section .card {
    background: rgba(255,255,255,0.95);
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    color: #333;
}

.voter-profile-section .card-header {
    border-radius: 15px 15px 0 0 !important;
    background: linear-gradient(135deg, #28a745, #20c997) !important;
}

.voter-avatar i {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.party-card {
    transition: all 0.3s ease;
    cursor: pointer;
    border: 3px solid transparent;
    position: relative;
    overflow: hidden;
}

.party-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    border-color: #007bff;
}

.party-card.selected {
    border-color: #28a745;
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
    box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
    transform: translateY(-5px);
}

.party-card.selected .card-body {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
}

.selection-badge {
    z-index: 10;
    animation: bounceIn 0.5s ease;
}

@keyframes bounceIn {
    0% { opacity: 0; transform: scale(0.3); }
    50% { opacity: 1; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
}

.select-candidate-btn {
    transition: all 0.3s ease;
    border-width: 2px;
    font-weight: 600;
}

.select-candidate-btn:hover {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border-color: #0056b3;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
}

.party-card.selected .select-candidate-btn {
    background: linear-gradient(135deg, #28a745, #20c997);
    border-color: #28a745;
    color: white;
}

.party-card.selected .select-candidate-btn:hover {
    background: linear-gradient(135deg, #218838, #1e7e34);
    border-color: #1e7e34;
}

#selected-candidate-info {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
    border: 2px solid #28a745;
    border-radius: 15px;
    animation: slideInDown 0.5s ease;
}

@keyframes slideInDown {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
}

#cast-selected-vote-btn {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
}

#cast-selected-vote-btn:hover {
    background: linear-gradient(135deg, #218838, #1e7e34);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
}

.candidate-vote-section {
    margin-top: auto;
}

/* Pulse animation for selected state */
.party-card.selected::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, #28a745, #20c997, #28a745);
    z-index: -1;
    border-radius: inherit;
    animation: borderPulse 2s ease-in-out infinite;
}

@keyframes borderPulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

.form-control {
    border-radius: 10px;
    border: none;
    padding: 12px 15px;
    background: rgba(255,255,255,0.9);
    color: #333;
}

.form-control:focus {
    background: white;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}

.btn {
    border-radius: 25px;
    padding: 12px 30px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.alert {
    border-radius: 15px;
    border: none;
}

#countdown {
    font-size: 1.2rem;
    font-weight: bold;
}

/* Animation for profile display */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.voter-profile-section {
    animation: slideInUp 0.6s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .aadhaar-card-template {
        width: 250px;
        height: 150px;
    }
    
    .aadhaar-verification-container {
        padding: 1rem;
    }
/* Enhanced Form Controls */
.form-control, .form-select {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: white;
    font-size: 1.1rem;
    padding: 1rem 1.5rem;
    transition: var(--transition);
    box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.7);
    font-style: italic;
}

.form-control:focus, .form-select:focus {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    box-shadow: 
        inset 0 4px 8px rgba(0, 0, 0, 0.1),
        0 0 0 0.2rem rgba(255, 255, 255, 0.25),
        0 8px 25px rgba(255, 255, 255, 0.2);
    color: white;
    outline: none;
}

.form-label {
    color: white;
    font-weight: 600;
    margin-bottom: 0.8rem;
    font-size: 1.1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* Enhanced Buttons */
.btn-primary {
    background: var(--vote-gradient);
    border: none;
    border-radius: 50px;
    padding: 1rem 2.5rem;
    font-size: 1.1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: var(--transition);
    box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
    position: relative;
    overflow: hidden;
}

.btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s ease;
}

.btn-primary:hover::before {
    left: 100%;
}

.btn-primary:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(17, 153, 142, 0.6);
    background: var(--vote-gradient);
    border: none;
}

.btn-success {
    background: var(--success-gradient);
    border: none;
    border-radius: 50px;
    padding: 1rem 2.5rem;
    font-weight: 700;
    transition: var(--transition);
    box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
}

.btn-success:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(79, 172, 254, 0.6);
    background: var(--success-gradient);
    border: none;
}

.btn-outline-primary {
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    background: transparent;
    border-radius: 50px;
    font-weight: 600;
    transition: var(--transition);
}

.btn-outline-primary:hover {
    background: var(--vote-gradient);
    border-color: transparent;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
}

.btn-outline-light {
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    background: transparent;
    border-radius: 50px;
    font-weight: 600;
    transition: var(--transition);
}

.btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    color: white;
    transform: translateY(-2px);
}

/* Enhanced Party Cards */
.party-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    transition: var(--transition);
    cursor: pointer;
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow-light);
}

.party-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: var(--primary-gradient);
    transform: scaleX(0);
    transition: transform 0.3s ease;
    transform-origin: left;
}

.party-card:hover::before {
    transform: scaleX(1);
}

.party-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-hover);
    border-color: rgba(255, 255, 255, 0.4);
}

.party-card.selected {
    background: linear-gradient(135deg, rgba(56, 239, 125, 0.3), rgba(17, 153, 142, 0.3));
    border-color: rgba(56, 239, 125, 0.6);
    transform: translateY(-8px) scale(1.02);
    box-shadow: 
        var(--shadow-hover),
        0 0 30px rgba(56, 239, 125, 0.4);
}

.party-card.selected::before {
    background: var(--vote-gradient);
    transform: scaleX(1);
}

.party-card .card-title {
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.party-card .card-text {
    color: rgba(255, 255, 255, 0.9);
}

.selection-badge {
    opacity: 0;
    transform: scale(0.8);
    transition: var(--transition);
}

.party-card.selected .selection-badge {
    opacity: 1;
    transform: scale(1);
}

/* Enhanced Alert Styles */
.alert {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    color: white;
    box-shadow: var(--shadow-light);
}

.alert-success {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.3), rgba(0, 242, 254, 0.3));
    border-color: rgba(79, 172, 254, 0.5);
}

.alert-danger {
    background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(238, 90, 82, 0.3));
    border-color: rgba(255, 107, 107, 0.5);
}

/* Enhanced Loading Styles */
.spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.4em;
}

.modal-content {
    background: var(--glass-bg);
    backdrop-filter: blur(25px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    box-shadow: var(--shadow-light);
    color: white;
}

/* Success Page Enhancements */
.text-success {
    color: #00f2fe !important;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.fas.fa-check-circle {
    animation: successBounce 0.8s ease-out;
    filter: drop-shadow(0 4px 8px rgba(0, 242, 254, 0.3));
}

@keyframes successBounce {
    0% { transform: scale(0) rotate(45deg); }
    50% { transform: scale(1.2) rotate(45deg); }
    100% { transform: scale(1) rotate(45deg); }
}

/* Responsive Enhancements */
@media (max-width: 768px) {
    .step-indicator {
        margin-bottom: 2rem;
    }
    
    .step {
        width: 50px;
        height: 50px;
        margin: 0 1rem;
        font-size: 1.3rem;
    }
    
    .party-card {
        margin-bottom: 1.5rem;
    }
    
    .btn-lg {
        padding: 0.8rem 2rem;
        font-size: 1rem;
    }
    
    .display-4 {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Step navigation
function goToStep(step) {
    console.log('ðŸ”„ Navigating to step:', step);
    
    // Hide all steps
    document.querySelectorAll('.verification-step').forEach(el => {
        el.classList.remove('active');
    });
    
    // Update step indicators
    document.querySelectorAll('.step').forEach((el, index) => {
        el.classList.remove('active', 'completed');
        if (index + 1 < step) {
            el.classList.add('completed');
        } else if (index + 1 === step) {
            el.classList.add('active');
        }
    });
    
    // Show target step
    const stepElements = {
        1: 'verification-form',
        2: 'email-verification',
        3: 'vote-casting',
        4: 'vote-success'
    };
    
    const targetElement = document.getElementById(stepElements[step]);
    if (targetElement) {
        targetElement.classList.add('active');
        console.log('âœ… Successfully showed step:', stepElements[step]);
    } else {
        console.error('âŒ Could not find step element:', stepElements[step]);
    }
    
    // Scroll to top smoothly
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    console.log('âœ… Navigation to step', step, 'completed');
}

// Aadhaar image upload handler
document.getElementById('aadhaar-image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        processAadhaarImage(file);
    }
});

// Process Aadhaar image (simulated OCR)
function processAadhaarImage(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        // Simulate OCR processing
        showLoading('Processing Aadhaar image...');
        
        setTimeout(() => {
            // Simulated extracted data (in real implementation, use OCR library)
            const extractedAadhaar = '123456789012'; // This would come from OCR
            
            // Update the visual card
            document.getElementById('display-aadhaar').textContent = formatAadhaarNumber(extractedAadhaar);
            document.getElementById('aadhaar_number').value = extractedAadhaar;
            
            hideLoading();
            
            // Auto-verify the extracted Aadhaar
            verifyAadhaarNumber(extractedAadhaar);
        }, 2000);
    };
    reader.readAsDataURL(file);
}

// Aadhaar verification form
document.getElementById('aadhaar-verification-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const aadhaarNumber = formData.get('aadhaar_number');
    
    if (!aadhaarNumber || aadhaarNumber.length !== 12) {
        showAlert('Please enter a valid 12-digit Aadhaar number', 'warning');
        return;
    }
    
    verifyAadhaarNumber(aadhaarNumber);
});

// Verify Aadhaar number against database
async function verifyAadhaarNumber(aadhaarNumber) {
    showLoading('Searching voter database...');
    
    // Create timeout controller
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
        controller.abort();
    }, 30000); // 30 second timeout
    
    try {
        const response = await fetch('{% url "voting:aadhaar_verification" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ aadhaar_number: aadhaarNumber }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            // Redirect to voter profile page
            if (result.redirect_url) {
                window.location.href = result.redirect_url;
            } else {
                // Fallback - display voter profile inline
                displayVoterProfile(result.voter);
            }
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        clearTimeout(timeoutId);
        hideLoading();
        
        if (error.name === 'AbortError') {
            showAlert('Request timed out. Please check your connection and try again.', 'warning');
        } else {
            console.error('Verification error:', error);
            showAlert('An error occurred during verification. Please try again.', 'danger');
        }
    }
}

// Display voter profile
function displayVoterProfile(voter) {
    document.getElementById('profile-name').textContent = voter.full_name;
    document.getElementById('profile-email').textContent = voter.email;
    document.getElementById('profile-aadhaar').textContent = formatAadhaarNumber(voter.aadhaar_number);
    
    // Update status based on voting eligibility
    const statusElement = document.getElementById('profile-status');
    if (voter.has_voted) {
        statusElement.textContent = 'Already Voted';
        statusElement.className = 'badge bg-warning';
    } else if (!voter.is_active) {
        statusElement.textContent = 'Not Eligible';
        statusElement.className = 'badge bg-danger';
    } else {
        statusElement.textContent = 'Eligible to Vote';
        statusElement.className = 'badge bg-success';
    }
    
    // Show profile section
    document.getElementById('voter-profile').style.display = 'block';
    
    // Store voter data for next step
    window.currentVoter = voter;
}

// Proceed to voting
function proceedToVoting() {
    if (window.currentVoter && !window.currentVoter.has_voted && window.currentVoter.is_active) {
        // Store voter info in session
        sessionStorage.setItem('verified_voter', JSON.stringify(window.currentVoter));
        goToStep(3); // Go directly to voting step
    } else {
        showAlert('You are not eligible to vote or have already voted', 'warning');
    }
}

// Reset verification
function resetVerification() {
    document.getElementById('voter-profile').style.display = 'none';
    document.getElementById('aadhaar_number').value = '';
    document.getElementById('display-aadhaar').textContent = 'XXXX XXXX XXXX';
    window.currentVoter = null;
}

// Format Aadhaar number for display
function formatAadhaarNumber(aadhaar) {
    return aadhaar.replace(/(\d{4})(\d{4})(\d{4})/, '$1 $2 $3');
}

// Email verification
document.getElementById('email-verification-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        verification_code: formData.get('verification_code')
    };
    
    showLoading('Verifying email...');
    
    try {
        const response = await fetch('{% url "voting:email_verification" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            goToStep(3);
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('An error occurred during email verification', 'danger');
    }
});

// Vote form submission
document.getElementById('vote-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Get selected party
    const selectedParty = document.querySelector('input[name="party_id"]:checked');
    if (!selectedParty) {
        showAlert('Please select a candidate before voting', 'warning');
        return;
    }
    
    const partyId = selectedParty.value;
    const partyName = selectedParty.closest('.party-card').querySelector('.card-title').textContent;
    
    // Show confirmation dialog
    if (confirm(`Are you sure you want to vote for ${partyName}? This action cannot be undone.`)) {
        await submitVote(partyId);
    }
});

// Submit vote to server
async function submitVote(partyId) {
    const data = {
        party_id: partyId
    };
    
    try {
        showLoading('Submitting your vote...');
        
        const response = await fetch('/cast-vote/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            // Show success message with vote details
            showAlert(`Vote cast successfully for ${result.party_name}!\n\nVote ID: ${result.vote_id}\nBlockchain Hash: ${result.blockchain_hash}\nTimestamp: ${new Date(result.timestamp).toLocaleString()}`, 'success');
            
            // Hide voting form and show success state
            document.getElementById('voting-form').style.display = 'none';
            document.getElementById('vote-success').style.display = 'block';
            
            // Update step indicator
            document.getElementById('step-3').classList.add('completed');
            
            // Disable all voting buttons
            const voteButtons = document.querySelectorAll('input[name="party_id"]');
            voteButtons.forEach(button => {
                button.disabled = true;
            });
            
            // Clear session data
            sessionStorage.removeItem('verified_voter');
            
        } else {
            showAlert(result.message, 'danger');
        }
        
    } catch (error) {
        hideLoading();
        console.error('Error submitting vote:', error);
        showAlert('An error occurred while submitting your vote. Please try again.', 'danger');
    }
}

// Utility functions
function showLoading(message) {
    document.getElementById('loading-message').textContent = message;
    new bootstrap.Modal(document.getElementById('loadingModal')).show();
}

function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) modal.hide();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.voting-container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// EmailJS OTP sending function
function sendOTPEmail(emailjsConfig) {
    return new Promise((resolve, reject) => {
        console.log('EmailJS Config received:', emailjsConfig);
        
        // Check if EmailJS is loaded
        if (typeof emailjs === 'undefined') {
            console.error('EmailJS library not loaded');
            reject(new Error('EmailJS library not loaded'));
            return;
        }
        
        // Initialize EmailJS with public key
        try {
            emailjs.init(emailjsConfig.public_key);
            console.log('EmailJS initialized with public key:', emailjsConfig.public_key);
        } catch (initError) {
            console.error('EmailJS initialization failed:', initError);
            reject(initError);
            return;
        }
        
        // Prepare template parameters
        const templateParams = {
            to_email: emailjsConfig.to_email || emailjsConfig.template_params?.to_email,
            to_name: emailjsConfig.voter_name || emailjsConfig.template_params?.to_name,
            verification_code: emailjsConfig.otp_code || emailjsConfig.template_params?.verification_code
        };
        
        console.log('Template params:', templateParams);
        console.log('Service ID:', emailjsConfig.service_id);
        console.log('Template ID:', emailjsConfig.template_id);
        
        // Send email using EmailJS
        emailjs.send(
            emailjsConfig.service_id,
            emailjsConfig.template_id,
            templateParams
        ).then(
            function(response) {
                console.log('Email sent successfully:', response);
                resolve(response);
            },
            function(error) {
                console.error('Email sending failed:', error);
                reject(error);
            }
        );
    });
}

// Check for verified voter data on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Page loaded - initializing voting system');
    
    // Check if user came from email verification
    const verifiedVoter = sessionStorage.getItem('verified_voter');
    if (verifiedVoter) {
        try {
            const voter = JSON.parse(verifiedVoter);
            displayVoterProfile(voter);
            
            // Check if URL has #voting-section to show voting interface
            if (window.location.hash === '#voting-section') {
                goToStep(2); // Go to voting step
            }
            
            // Clear the session storage to prevent reuse
            sessionStorage.removeItem('verified_voter');
        } catch (error) {
            console.error('Error parsing verified voter data:', error);
            sessionStorage.removeItem('verified_voter');
        }
    }
    
    console.log('âœ… Voting system initialized');
});

</script>
{% endblock %}