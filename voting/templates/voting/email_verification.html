{% extends 'voting/base.html' %}
{% load static %}

{% block title %}Email Verification - Secure Voting System{% endblock %}

{% block extra_head %}
<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="text/javascript">
    (function(){
        emailjs.init("{{ emailjs_public_key }}");
    })();
</script>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">
                        <i class="fas fa-envelope-open-text me-2"></i>
                        Email Verification
                    </h4>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="verification-icon mb-3">
                            <i class="fas fa-shield-alt text-success" style="font-size: 3rem;"></i>
                        </div>
                        <p class="text-muted">
                            We've sent a 6-digit verification code to your email address.
                            Please enter the code below to verify your identity.
                        </p>
                        <p class="fw-bold text-primary" id="voter-email">{{ voter_email }}</p>
                    </div>

                    <!-- Verification Form -->
                    <form id="verification-form">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="verification-code" class="form-label fw-bold">
                                Verification Code
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg text-center" 
                                   id="verification-code" 
                                   name="verification_code"
                                   placeholder="Enter 6-digit code"
                                   maxlength="6"
                                   pattern="[0-9]{6}"
                                   required>
                            <div class="form-text text-center">
                                Enter the 6-digit code sent to your email
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="verify-btn">
                                <i class="fas fa-check-circle me-2"></i>
                                Verify Code
                            </button>
                        </div>
                    </form>

                    <!-- Resend Section -->
                    <div class="text-center mt-4">
                        <p class="text-muted mb-2">Didn't receive the code?</p>
                        <button type="button" class="btn btn-outline-secondary" id="resend-btn">
                            <i class="fas fa-redo me-2"></i>
                            Resend Code
                        </button>
                        <div class="mt-2">
                            <small class="text-muted" id="resend-timer"></small>
                        </div>
                    </div>

                    <!-- Status Messages -->
                    <div id="status-messages" class="mt-3"></div>

                    <!-- Verification Attempts -->
                    <div class="mt-3" id="attempts-info" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="attempts-text"></span>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-light text-center">
                    <small class="text-muted">
                        <i class="fas fa-lock me-1"></i>
                        Your verification is secured with end-to-end encryption
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('verification-form');
    const verifyBtn = document.getElementById('verify-btn');
    const resendBtn = document.getElementById('resend-btn');
    const codeInput = document.getElementById('verification-code');
    const statusMessages = document.getElementById('status-messages');
    const attemptsInfo = document.getElementById('attempts-info');
    const attemptsText = document.getElementById('attempts-text');
    const resendTimer = document.getElementById('resend-timer');
    
    let resendCooldown = 0;
    let resendInterval;

    // Auto-format verification code input
    codeInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length > 6) value = value.slice(0, 6);
        e.target.value = value;
        
        // Auto-submit when 6 digits are entered
        if (value.length === 6) {
            setTimeout(() => form.dispatchEvent(new Event('submit')), 100);
        }
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const code = codeInput.value.trim();
        if (code.length !== 6) {
            showMessage('Please enter a 6-digit verification code', 'error');
            return;
        }
        
        verifyCode(code);
    });

    // Handle resend button
    resendBtn.addEventListener('click', function() {
        if (resendCooldown > 0) return;
        resendVerificationEmail();
    });

    function verifyCode(code) {
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
        
        fetch('{% url "voting:email_verification" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                verification_code: code
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Email verified successfully! Redirecting to voting...', 'success');
                clearInterval(statusCheckInterval);
                clearInterval(sessionRefreshInterval);
                setTimeout(() => {
                    window.location.href = '{% url "voting:cast_vote" %}';
                }, 1500);
            } else {
                // Handle specific error cases
                if (data.message.includes('session expired') || data.redirect_url) {
                    showMessage('Session expired. Redirecting to verification page...', 'error');
                    setTimeout(() => {
                        window.location.href = data.redirect_url || '{% url "voting:aadhaar_verification" %}';
                    }, 2000);
                    return;
                }
                
                showMessage(data.message || 'Verification failed', 'error');
                
                // Show remaining attempts if provided
                if (data.remaining_attempts !== undefined) {
                    attemptsText.textContent = `Remaining attempts: ${data.remaining_attempts}`;
                    attemptsInfo.style.display = 'block';
                    
                    if (data.remaining_attempts === 0) {
                        verifyBtn.disabled = true;
                        codeInput.disabled = true;
                        showMessage('Maximum verification attempts exceeded. Please request a new code.', 'error');
                    }
                }
                
                codeInput.value = '';
                codeInput.focus();
            }
        })
        .catch(error => {
            console.error('Verification error:', error);
            showMessage('An error occurred during verification', 'error');
        })
        .finally(() => {
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Verify Code';
        });
    }

    function resendVerificationEmail() {
        resendBtn.disabled = true;
        resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
        
        const voterEmail = document.getElementById('voter-email').textContent.trim();
        
        fetch('{% url "voting:resend_verification" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                email: voterEmail
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Verification code resent successfully!', 'success');
                startResendCooldown(60); // 60 seconds cooldown
                
                // Reset attempts if new code was sent
                attemptsInfo.style.display = 'none';
                verifyBtn.disabled = false;
                codeInput.disabled = false;
                codeInput.value = '';
                codeInput.focus();
            } else {
                // Handle session expiration
                if (data.message.includes('session') || data.redirect_url) {
                    showMessage('Session expired. Redirecting to verification page...', 'error');
                    setTimeout(() => {
                        window.location.href = data.redirect_url || '{% url "voting:aadhaar_verification" %}';
                    }, 2000);
                    return;
                }
                showMessage(data.message || 'Failed to resend verification code', 'error');
            }
        })
        .catch(error => {
            console.error('Resend error:', error);
            showMessage('An error occurred while resending the code', 'error');
        })
        .finally(() => {
            if (resendCooldown === 0) {
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend Code';
            }
        });
    }

    function startResendCooldown(seconds) {
        resendCooldown = seconds;
        resendBtn.disabled = true;
        
        resendInterval = setInterval(() => {
            resendCooldown--;
            resendTimer.textContent = `Resend available in ${resendCooldown} seconds`;
            
            if (resendCooldown <= 0) {
                clearInterval(resendInterval);
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend Code';
                resendTimer.textContent = '';
            }
        }, 1000);
    }

    function showMessage(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        
        statusMessages.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Auto-dismiss success messages
        if (type === 'success') {
            setTimeout(() => {
                const alert = statusMessages.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 3000);
        }
    }

    // Focus on code input when page loads
    codeInput.focus();

    // Check verification status periodically
    let statusCheckInterval = setInterval(() => {
        fetch('{% url "voting:verification_status" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.verification_status) {
                const status = data.verification_status;
                if (status.is_expired) {
                    showMessage('Verification code has expired. Please request a new one.', 'error');
                    verifyBtn.disabled = true;
                    codeInput.disabled = true;
                    clearInterval(statusCheckInterval);
                }
            } else if (!data.success && data.message.includes('session')) {
                showMessage('Session expired. Redirecting to verification page...', 'error');
                setTimeout(() => {
                    window.location.href = '{% url "voting:aadhaar_verification" %}';
                }, 2000);
                clearInterval(statusCheckInterval);
            }
        })
        .catch(error => console.error('Status check error:', error));
    }, 30000); // Check every 30 seconds
    
    // Refresh session periodically to prevent timeout
    let sessionRefreshInterval = setInterval(() => {
        fetch('{% url "voting:refresh_verification_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.log('Session refresh failed:', data.message);
                clearInterval(sessionRefreshInterval);
            }
        })
        .catch(error => console.error('Session refresh error:', error));
    }, 600000); // Refresh every 10 minutes
});
</script>
{% endblock %}